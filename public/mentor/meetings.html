<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meetings - MentorMentee</title>
  <link rel="stylesheet" href="../css/modern-styles.css">
  <link rel="stylesheet" href="css/mobile-optimizations.css">
  <script src="../js/notification-badge.js"></script>
  <script src="js/mobile-menu.js" defer></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container navbar-container">
      <a href="/" class="navbar-brand">MentorMentee</a>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="#" class="nav-link">Meetings</a></li>
        <li><a href="chat.html" class="nav-link">Messages</a></li>
        <li style="position: relative;">
          <a href="notifications.html" class="nav-link">
            Notifications
          </a>
        </li>
        <li><a href="profile.html" class="nav-link">Profile</a></li>
        <li><a href="../people.html" class="nav-link">People</a></li>
        <li><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h1>Your Meetings</h1>
        <p>Schedule and manage your mentoring sessions</p>
      </div>
      <button id="scheduleMeetingBtn" class="btn btn-primary">Schedule New Meeting</button>
    </div>

    <!-- Upcoming Meetings -->
    <div class="card">
      <h3>Upcoming Meetings</h3>
      <div id="upcomingMeetings">
        <p style="text-align: center; color: var(--gray); padding: 2rem;">No upcoming meetings scheduled</p>
      </div>
    </div>

    <!-- Past Meetings -->
    <div class="card">
      <h3>Past Meetings</h3>
      <div id="pastMeetings">
        <p style="text-align: center; color: var(--gray); padding: 2rem;">No past meetings</p>
      </div>
    </div>
  </main>

  <!-- Schedule Meeting Modal -->
  <div id="scheduleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top: 0;">Schedule New Meeting</h2>
      
      <form id="scheduleForm">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Student</label>
          <select id="studentSelect" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Choose a student...</option>
          </select>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Meeting Title</label>
          <input type="text" id="meetingTitle" required placeholder="e.g., Project Review" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
          <textarea id="meetingDescription" rows="3" placeholder="Meeting agenda and topics" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date & Time</label>
          <input type="datetime-local" id="meetingDate" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Duration (minutes)</label>
          <input type="number" id="meetingDuration" value="60" min="15" step="15" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Meeting Link (optional)</label>
          <input type="url" id="meetingLink" placeholder="https://meet.google.com/..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Schedule Meeting</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allStudents = [];

    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }

      // Load current user info
      loadCurrentUser();
      
      // Load students for dropdown
      loadStudents();
      
      // Load meetings
      loadMeetings();

      // Schedule meeting button
      document.getElementById('scheduleMeetingBtn').addEventListener('click', function() {
        document.getElementById('scheduleModal').style.display = 'flex';
      });

      // Cancel button
      document.getElementById('cancelBtn').addEventListener('click', function() {
        document.getElementById('scheduleModal').style.display = 'none';
        document.getElementById('scheduleForm').reset();
      });

      // Schedule form submit
      document.getElementById('scheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        scheduleMeeting();
      });
      
      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('userRole');
          window.location.href = '/';
        }
      });
    });

    async function loadCurrentUser() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch('/api/auth/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (response.ok) {
          currentUser = await response.json();
        }
      } catch (error) {
        console.error('Error loading current user:', error);
      }
    }

    async function loadStudents() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch('/api/users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
          const users = await response.json();
          allStudents = users.filter(u => u.role === 'student');
          
          const select = document.getElementById('studentSelect');
          select.innerHTML = '<option value="">Choose a student...</option>';
          
          allStudents.forEach(student => {
            const option = document.createElement('option');
            option.value = student._id;
            option.textContent = student.name || student.username;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    async function loadMeetings() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch('/api/meetings', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
          const meetings = await response.json();
          displayMeetings(meetings);
        }
      } catch (error) {
        console.error('Error loading meetings:', error);
      }
    }

    function displayMeetings(meetings) {
      const now = new Date();
      const upcoming = meetings.filter(m => new Date(m.date) >= now);
      const past = meetings.filter(m => new Date(m.date) < now);

      // Display upcoming meetings
      const upcomingDiv = document.getElementById('upcomingMeetings');
      if (upcoming.length === 0) {
        upcomingDiv.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No upcoming meetings scheduled</p>';
      } else {
        upcomingDiv.innerHTML = upcoming.map(meeting => createMeetingCard(meeting, false)).join('');
      }

      // Display past meetings
      const pastDiv = document.getElementById('pastMeetings');
      if (past.length === 0) {
        pastDiv.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No past meetings</p>';
      } else {
        pastDiv.innerHTML = past.map(meeting => createMeetingCard(meeting, true)).join('');
      }
    }

    function createMeetingCard(meeting, isPast) {
      const date = new Date(meeting.date);
      const dateStr = formatDateTime(date);
      const studentName = meeting.student?.name || meeting.student?.username || 'Student';
      
      return `
        <div class="meeting-card">
          <div class="meeting-header" style="${isPast ? 'background: #e2e8f0; color: var(--dark);' : ''}">
            <h4>${meeting.title}</h4>
            <p style="margin: 0; opacity: 0.9;">${dateStr}</p>
          </div>
          <div class="meeting-body">
            <p>${meeting.description || 'No description provided'}</p>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <span style="background: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.8rem;">${meeting.duration} min</span>
              ${meeting.status ? `<span style="background: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.8rem;">${meeting.status}</span>` : ''}
            </div>
          </div>
          <div class="meeting-footer">
            <div>
              <p style="margin: 0; font-weight: 600;">${studentName}</p>
              <p style="margin: 0; font-size: 0.9rem; color: var(--gray);">Student</p>
            </div>
            <div>
              ${meeting.meetingLink && !isPast ? `<a href="${meeting.meetingLink}" target="_blank" class="btn btn-secondary btn-sm">Join Meeting</a>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function formatDateTime(date) {
      const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      };
      return date.toLocaleDateString('en-US', options);
    }

    async function scheduleMeeting() {
      const token = localStorage.getItem('token');
      const studentId = document.getElementById('studentSelect').value;
      const title = document.getElementById('meetingTitle').value;
      const description = document.getElementById('meetingDescription').value;
      const date = document.getElementById('meetingDate').value;
      const duration = parseInt(document.getElementById('meetingDuration').value);
      const meetingLink = document.getElementById('meetingLink').value;

      if (!studentId) {
        alert('Please select a student');
        return;
      }

      if (!currentUser) {
        alert('User information not loaded. Please refresh the page.');
        return;
      }

      try {
        const response = await fetch('/api/meetings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            mentorId: currentUser._id,
            studentId: studentId,
            title: title,
            description: description,
            date: date,
            duration: duration,
            meetingLink: meetingLink
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          alert('Meeting scheduled successfully!');
          document.getElementById('scheduleModal').style.display = 'none';
          document.getElementById('scheduleForm').reset();
          loadMeetings(); // Reload meetings
        } else {
          alert(data.message || 'Failed to schedule meeting');
        }
      } catch (error) {
        console.error('Error scheduling meeting:', error);
        alert('Error scheduling meeting. Please try again.');
      }
    }
  </script>
</body>
</html>
