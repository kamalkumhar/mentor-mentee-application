<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resources - Mentor Dashboard</title>
  <link rel="stylesheet" href="../css/modern-styles.css">
  <link rel="stylesheet" href="css/mobile-optimizations.css">
  <script src="../js/notification-badge.js"></script>
  <script src="js/mobile-menu.js" defer></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container navbar-container">
      <a href="/" class="navbar-brand">MentorMentee</a>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="meetings.html" class="nav-link">Meetings</a></li>
        <li><a href="chat.html" class="nav-link">Messages</a></li>
        <li style="position: relative;">
          <a href="notifications.html" class="nav-link">
            Notifications
            <span class="notification-badge">0</span>
          </a>
        </li>
        <li><a href="profile.html" class="nav-link">Profile</a></li>
        <li><a href="../people.html" class="nav-link">People</a></li>
        <li><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
      <div>
        <h1>📚 Learning Resources</h1>
        <p>Share study materials and resources with your students</p>
      </div>
      <button onclick="window.location.href='dashboard.html'" class="btn btn-secondary">
        ← Back to Dashboard
      </button>
    </div>

    <!-- Upload Section -->
    <div class="card">
      <h3>Upload New Resource</h3>
      <form id="uploadForm" style="margin-top: 1rem;">
        <div class="form-group">
          <label for="title" class="form-label">Resource Title</label>
          <input type="text" id="title" class="form-control" placeholder="e.g., Data Structures Notes" required>
        </div>

        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" class="form-control" rows="3" placeholder="Brief description of the resource"></textarea>
        </div>

        <div class="form-group">
          <label for="file" class="form-label">Select File</label>
          <input type="file" id="file" class="form-control" required>
          <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
            Allowed: PDF, DOC, PPT, XLS, TXT, ZIP, Images | Max size: 10MB
          </small>
        </div>

        <button type="submit" class="btn btn-primary">
          <span id="uploadBtnText">📤 Upload Resource</span>
          <span id="uploadSpinner" style="display: none;">Uploading...</span>
        </button>
      </form>
    </div>

    <!-- Resources List -->
    <div class="card" style="margin-top: 2rem;">
      <h3>Your Uploaded Resources</h3>
      <div id="resourcesList" style="margin-top: 1rem;">
        <div style="text-align: center; padding: 2rem; color: var(--gray);">
          Loading resources...
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('userRole');
          window.location.href = '/';
        }
      });

      // Load resources
      loadResources(token);

      // Upload form submit
      document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadResource(token);
      });
    });

    function uploadResource(token) {
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a file to upload');
        return;
      }

      // Check file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
      }

      // Show loading state
      const uploadBtn = document.querySelector('#uploadForm button[type="submit"]');
      const uploadBtnText = document.getElementById('uploadBtnText');
      const uploadSpinner = document.getElementById('uploadSpinner');
      uploadBtnText.style.display = 'none';
      uploadSpinner.style.display = 'inline';
      uploadBtn.disabled = true;

      // Create form data
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      formData.append('file', file);

      // Upload file
      fetch('/api/resources/upload', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.resource) {
          alert('Resource uploaded successfully!');
          // Reset form
          document.getElementById('uploadForm').reset();
          // Reload resources
          loadResources(token);
        } else {
          alert(data.message || 'Failed to upload resource');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error uploading resource. Please try again.');
      })
      .finally(() => {
        uploadBtnText.style.display = 'inline';
        uploadSpinner.style.display = 'none';
        uploadBtn.disabled = false;
      });
    }

    function loadResources(token) {
      fetch('/api/resources', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
      .then(response => response.json())
      .then(resources => {
        displayResources(resources);
      })
      .catch(error => {
        console.error('Error loading resources:', error);
        document.getElementById('resourcesList').innerHTML = 
          '<div style="text-align: center; padding: 2rem; color: var(--danger);">Error loading resources</div>';
      });
    }

    function displayResources(resources) {
      const container = document.getElementById('resourcesList');

      if (resources.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--gray);">
            <p style="font-size: 2rem; margin-bottom: 0.5rem;">📭</p>
            <p>No resources uploaded yet</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Upload your first resource using the form above!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = resources.map(resource => {
        const uploadDate = new Date(resource.uploadedAt);
        const dateStr = uploadDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        const fileSize = formatFileSize(resource.fileSize);
        const fileIcon = getFileIcon(resource.fileType);

        return `
          <div style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; flex: 1;">
              <div style="font-size: 2.5rem; margin-right: 1rem;">${fileIcon}</div>
              <div style="flex: 1;">
                <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">${resource.title}</h4>
                <p style="margin: 0; color: var(--gray); font-size: 0.9rem;">
                  <strong>File:</strong> ${resource.originalName} (${fileSize})
                </p>
                ${resource.description ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">${resource.description}</p>` : ''}
                <p style="margin: 0.5rem 0 0 0; color: var(--gray); font-size: 0.85rem;">
                  Uploaded on ${dateStr}
                </p>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="downloadResource('${resource._id}', '${resource.originalName}')" class="btn btn-primary btn-sm">
                📥 Download
              </button>
              <button onclick="deleteResource('${resource._id}')" class="btn btn-danger btn-sm">
                🗑️ Delete
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getFileIcon(fileType) {
      if (fileType.includes('pdf')) return '📄';
      if (fileType.includes('word') || fileType.includes('doc')) return '📝';
      if (fileType.includes('powerpoint') || fileType.includes('presentation')) return '📊';
      if (fileType.includes('excel') || fileType.includes('sheet')) return '📈';
      if (fileType.includes('image')) return '🖼️';
      if (fileType.includes('zip') || fileType.includes('rar')) return '📦';
      return '📎';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function downloadResource(resourceId, filename) {
      const token = localStorage.getItem('token');
      window.location.href = `/api/resources/download/${resourceId}`;
    }

    function deleteResource(resourceId) {
      if (!confirm('Are you sure you want to delete this resource?')) {
        return;
      }

      const token = localStorage.getItem('token');
      
      console.log('Deleting resource:', resourceId);
      
      fetch(`/api/resources/${resourceId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
      .then(response => {
        console.log('Delete response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Delete response data:', data);
        alert(data.message);
        if (data.message.includes('successfully') || data.message.includes('deleted')) {
          loadResources(token);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting resource');
      });
    }
  </script>
</body>
</html>
